<div id="react-mapping-content" class='react-mapping-content'></div>

<% content_for :javascript do %>
  <script type='text/babel'>
    const { useMemo, useState, useCallback } = React;
    const App = ({ columnNames, projectFields, locale, projectType }) => {
      const [selectedColumnNames, setSelectedColumnNames] = useState({});
      const [selectedSubfields, setSelectedSubfields] = useState({});
      const [projectSubfields, setProjectSubfields] = useState([]);

      const selectedColumnNamesList = useMemo(() => Object.values(selectedColumnNames), [selectedColumnNames]);

      const availableColumnNames = useMemo(() => {
        return columnNames.filter(column => !selectedColumnNamesList.includes(column));
      }, [selectedColumnNamesList, columnNames]);

      const handleChange = useCallback(
        ({ target: { value, name } }) => {
          setSelectedColumnNames({ ...selectedColumnNames, [name]: value });
        },
        [selectedColumnNames]
      );

      const handleChangeProjectField = useCallback(
        ({ target: { value } }) => {
          $.ajax({
            url: `/${locale}/project_types/${projectType.id}/project_fields/${value}/project_subfields`,
            method: "GET",
            dataType: "json",
            error: function (xhr, status, error) {
                console.error('AJAX Error: ' + status + error);
            },
            success: function (response) {
              setProjectSubfields(response.project_subfields)
            }
          });
        },
        [locale, projectType.id]
      )

      const availableOptions = useCallback(component => {
        return (
          [
            <option value=""></option>,
            ...columnNames.map(columnName => {
                const shouldBeHidden = selectedColumnNamesList.includes(columnName);
                return <option value={columnName} className={shouldBeHidden && 'select__option--hidden'}>{columnName}</option>
              })
          ]

        )
      }, [columnNames, selectedColumnNamesList]);

      const handleChangeSubfield = useCallback(
        ({ target: { name, value } }) => {
          setSelectedSubfields({ ...selectedSubfields, [name]: value });
        },
        [selectedSubfields]
      );

      const availableSubfieldOptions = useCallback(component => {
        return (
          [
            <option value=""></option>,
            ...projectSubfields.map(projectSubfield => {
                const shouldBeHidden = Object.values(selectedSubfields).includes(`${projectSubfield.id}`) && selectedSubfields[component] !== `${projectSubfield.id}`
                return <option value={projectSubfield.id} className={shouldBeHidden && 'select__option--hidden'}>{projectSubfield.name}</option>
              })
          ]

        )
      }, [projectSubfields, selectedSubfields]);

      const availableProjectFields = useMemo(() => {
        return (
          [
            <option value=""></option>,
            ...projectFields.map(projectField => {
                return <option value={projectField.id}>{projectField.name}</option>
              })
          ]
        )
      }, [projectFields]);

      const removeColumnName = useCallback(
        columnName => () => {
          setSelectedColumnNames({ ...selectedColumnNames, [columnName]: columnName });
        },
        [selectedColumnNames]
      )

      return (
        <div>
          <div className="card m-2 shadow">
            <div className="card-body p-3">
              <div className="row justify-content-center">
                <h2 className="mx-0">Importación de subformularios</h2>
              </div>
            </div>
          </div>
          <div className="card m-2 shadow">
            <div className="card-body" >
              <div className="" style={{display: "block", height: "65vh", overflow: "auto", overflowX: "hidden"}}>
                <form className="" action="<%= import_project_type_data_children_path(@project_type) %>" method="post" id="form_data_children_import">
                  <div className="react-mapping-content__general-data py-3 my-3 mx-auto ">
                    <div className="row my-2">
                      <div className="col-6">
                        <label for="mapping[project_id]">Id del polígono</label>
                      </div>
                      <div className="col-6">
                        <select className="select form-control form-control-sm" name="mapping[project_id]" onChange={handleChange} style={{display:'inline'}}>
                          {availableOptions('project_id')}
                        </select>
                      </div>
                    </div>
                    <div className="row my-2">
                      <div className="col-6">
                        <label for="mapping[gwm_created_at]">Fecha y formato</label>
                      </div>
                      <div className="col-3">
                        <select className="select form-control form-control-sm" name="mapping[gwm_created_at]" onChange={handleChange} style={{display:'inline'}}>
                          {availableOptions('gwm_created_at')}
                        </select>
                      </div>
                      <div className="col-3">
                        <select className="select form-control form-control-sm" name="mapping[gwm_created_at_format]" style={{display:'inline'}}>
                          <option value=""></option>
                          <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                          <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                          <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                        </select>
                      </div>
                    </div>
                    <div className="row my-2">
                      <div className="col-6">
                        <label for="mapping[project_field_id]">Campo modelo de datos</label>
                      </div>
                      <div className="col-6">  
                        <select className="select form-control form-control-sm" name="mapping[project_field_id]" onChange={handleChangeProjectField} style={{display:'inline'}}>
                          {availableProjectFields}
                        </select>
                      </div>
                    </div>
                    <div className="row my-2">
                      <div className="col-6">
                        <label for="mapping[project_field_id]">Columna Id usuario</label>
                      </div>
                      <div className="col-6">
                        <select className="select form-control form-control-sm" name="mapping[user_id]" onChange={handleChange} style={{display:'inline'}}>
                          {availableOptions('user_id')}
                        </select>
                      </div>
                    </div>
                   
                    

                    
                  </div>
                  <div className="react-mapping-content__data-children  py-3 my-3 mx-auto">
                    <h3 className="react-mapping-content__subtitle">
                      Relación columna campo
                      <span><i class="fas fa-exclamation-circle"></i> Las columnas vacías no serán importadas</span>
                    </h3>
                    <div className="react-mapping-content__data-children__wrapper">
                      {availableColumnNames.map(columnName => {
                        return (
                          <div className="react-mapping-content__data-children__attribute" key={columnName}>
                            <label
                              for={`mapping[data_child][${columnName}]`}
                              className="react-mapping-content__data-children__attribute__name"
                            >
                              {columnName}
                            </label>
                            <i className="fa fa-arrow-right"></i>
                            <select className="select form-control form-control-sm" name={`mapping[data_child][${columnName}]`} onChange={handleChangeSubfield} style={{display:'inline'}}>
                              {availableSubfieldOptions(`mapping[data_child][${columnName}]`)}
                            </select>
                            <button
                              type="button"
                              name="button"
                              className="react-mapping-content__data-children__attribute__remove-button"
                              onClick={removeColumnName(columnName)}
                            >
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                  
                    
                  
                </form>
                
              </div>
              <div className="row justify-content-center pt-1 my-1">
                <div className="react-mapping-content__actions">
                        <a
                          href={`/${locale}/project_types/${projectType.id}/data_children/new`}
                          className="btn btn-secondary mr-1"
                        >
                          Cancelar
                        </a>
                        <button type="submit" className="enviar btn btn-primary" form="form_data_children_import">Guardar</button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      )
    }

    const columnNames = <%= raw @file_headers.to_json %>;
    const projectFields = <%= raw @project_fields.to_json %>;
    const locale = "<%= @locale %>";
    const projectType = <%= raw @project_type.to_json %>;
    ReactDOM.render(
      <App columnNames={columnNames} projectFields={projectFields} locale={locale} projectType={projectType} />,
      document.querySelector('#react-mapping-content')
    );
  </script>
<% end %>
