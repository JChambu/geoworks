<%= content_for :head do %>

  <script type="text/javascript">
    Navarra.dashboards.config.current_tenement = '<%= current_tenement_helper %>';
    Navarra.dashboards.config.user_name = '<%= current_user.name %>';
    <% if !@project_type.nil? %>
      Navarra.dashboards.config.project_type_id = <%= @project_type.id %>
      Navarra.dashboards.config.current_tenant = '<%= @current_tenant %>';
      Navarra.dashboards.config.name_layer = '<%= @project_type.name_layer %>';
      Navarra.dashboards.config.name_project = '<%= @project_type.name %>';
      Navarra.dashboards.config.type_geometry = '<%= @project_type.type_geometry %>';
    <% end %>
    <% if !@dashboard.nil? %>
      Navarra.dashboards.config.dashboard_id = <%= @dashboard.id %>
    <% end %>
    <% if @extent.length > 0  %>
      Navarra.dashboards.config.minx = <%= @extent[0].minx %>
      Navarra.dashboards.config.miny = <%= @extent[0].miny  %>
      Navarra.dashboards.config.maxx = <%= @extent[0].maxx  %>
      Navarra.dashboards.config.maxy = <%= @extent[0].maxy %>
    <% end %>

    // TODO: Ahora que se aplican los filtros en los datos esta lógica
    // se está duplicando hay que unficarla con el controlador

    // Carga filtro por atributos y owner
    <% if @project_filter %>

      <% if !@project_filter.properties.nil? %>
        <% @project_filter.properties.each do |p| %>

          var field_key = '<%= p[0] %>';
          var operator = '=';
          var value = '<%= p[1] %>';

          // Aplica modificaciones si el value es array
          if (value.match(/&quot;/g) != null) {
            value = value.replace(/&quot;/g, '\"')
          }

          var filter = field_key + '|' + operator + '|\'' + value + '\'';
          Navarra.project_types.config.attribute_filters.push(filter);

        <% end %>
      <% end %>
      Navarra.project_types.config.owner = <%= @project_filter.owner %>;
    <% end %>

    <% if @cross_layer_filter %>
      <% if !@cross_layer_filter.properties.nil? %>
        <% @cross_layer_filter.properties.each do |f| %>

        var field_key = '<%= f[0] %>';
        var operator = '=';
        var value = '<%= f[1] %>';

        // Aplica modificaciones si el value es array
        if (value.match(/&quot;/g) != null) {
          value = value.replace(/&quot;/g, '\"')
        }

        var contained_filter = field_key + '|' + operator + '|\'' + value + '\'';
        Navarra.project_types.config.cross_layer_filter.push(contained_filter);

        <% end %>
      <% end %>
      Navarra.project_types.config.cross_layer_owner = <%= @cross_layer_filter.owner %>;
    <% end %>

    <% if @cross_layer %>
      Navarra.project_types.config.cross_layer = '<%= @cross_layer %>';
    <% end %>

    //cerrar paneles laterales
    function hidde_sidebar(container){
      //Minimizar la pantalla
      if(container=='timeslider-container'){var height = height_time_slider;}
      if(container=='filter-container'){var height = height_filters;}
      if(container=='charts-container'){var height = height_charts;}
      $('#'+container).css('height','0px');
      $('#'+container).css('width',"100%");
      $('#'+container).css('left',"0%");
      $('#sidebar_all').removeClass(container);
      if(container!='charts-container' && ($('#sidebar_all').hasClass('charts-container') || $('#sidebar_all').hasClass('charts-container_expanded'))){
        setTimeout(function(){
          resize_graphics();
        }, 700);
      }
      $('#sidebar_all').removeClass(container+"_expanded");
      //si están los 3 paneles ocultos
      if(!$('#sidebar_all').hasClass('charts-container') && !$('#sidebar_all').hasClass('timeslider-container') && !$('#sidebar_all').hasClass('filter-container') && !$('#sidebar_all').hasClass('charts-container_expanded') && !$('#sidebar_all').hasClass('timeslider-container_expanded') && !$('#sidebar_all').hasClass('filter-container_expanded')){
        $(".leaflet-right").css("margin-right", "0%");
        $(".table_data_container").css("transition-delay", "0.2s");
        $(".table_data_container").css("width", "100%");
      } else {
        if(!$('#sidebar_all').hasClass('charts-container_expanded') && !$('#sidebar_all').hasClass('timeslider-container_expanded') && !$('#sidebar_all').hasClass('filter-container_expanded')){
          $(".leaflet-right").css("margin-right", "30%");
          $(".table_data_container").css("width", "70%");
        }
      }
    }

    //abrir paneles laterales
    function show_sidebar(container){
      //Pantalla standard
      //si están los 3 paneles ocultos
      if(!$('#sidebar_all').hasClass('charts-container') && !$('#sidebar_all').hasClass('timeslider-container') && !$('#sidebar_all').hasClass('filter-container') && !$('#sidebar_all').hasClass('charts-container_expanded') && !$('#sidebar_all').hasClass('timeslider-container_expanded') && !$('#sidebar_all').hasClass('filter-container_expanded')){
        $(".leaflet-right").css("margin-right", "30%");
        $(".table_data_container").css("width", "70%");
        $(".table_data_container").css("transition-delay", "0s");
      }
      var need_recalculate = false;
      var need_draw_charts = false;
      if(container == "charts-container"){
        if(!$('#sidebar_all').hasClass('charts-container') && !$('#sidebar_all').hasClass('charts-container_expanded')){
          // el charts-container estaba oculto, necesita recalcular gráficos
            need_recalculate = true;
        }
        if(!$('#sidebar_all').hasClass('charts-container') && $('#sidebar_all').hasClass('charts-container_expanded')){
            // el charts-container estaba expandido, necesita redibujar graficos
            need_draw_charts = true;
        }
      }
      $('#sidebar_all').removeClass(container+"_expanded");
      if(!$('#sidebar_all').hasClass('charts-container_expanded') && !$('#sidebar_all').hasClass('timeslider-container_expanded') && !$('#sidebar_all').hasClass('filter-container_expanded')){
        $(".leaflet-right").css("margin-right", "30%");
        $(".table_data_container").css("width", "70%");
      }
      if(container=='timeslider-container'){var height = height_time_slider;}
      if(container=='filter-container'){var height = height_filters;}
      if(container=='charts-container'){var height = height_charts;}
      $('#'+container).css('height',height);
      $('#'+container).css('width',"100%");
      $('#'+container).css('left',"0%");
      $('#sidebar_all').addClass(container);
      if(need_recalculate){init_chart_doughnut();}
      if(need_draw_charts){draw_charts();}
      if($('#sidebar_all').hasClass('charts-container')){
        setTimeout(function(){
          resize_graphics();
        }, 700);
      }
    }

    //expandir paneles laterales
    function expand_sidebar(container){
      //Pantalla extendida
      $('#'+container).css('width',"200%");
      $('#'+container).css('left',"-100%");
      $(".table_data_container").css("width", "40%");
      $(".leaflet-right").css("margin-right", "60%");
      var need_draw_charts = false;
      if(container == "charts-container"){
        if($('#sidebar_all').hasClass('charts-container') && !$('#sidebar_all').hasClass('charts-container_expanded')){
          // el charts-container estaba expandido, necesita redibujar graficos
            need_draw_charts = true;
        }
      }
      $('#sidebar_all').addClass(container+"_expanded");
      $('#sidebar_all').removeClass(container);
      if(need_draw_charts){draw_charts();}
      if($('#sidebar_all').hasClass('charts-container_expanded')){
        setTimeout(function(){
          resize_graphics();
        }, 700);
      }
    }

  </script>

<% end %>

<div class="fakeLoader"></div>

<div class="modal fade" id="modal-window" tabindex="-1" role="dialog" aria-labelledby="chartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content"></div>
  </div>
</div>

<div id="filters-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content"></div>
  </div>
</div>

<div id="time-slider-modal" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="chartModalLabel"> Time Slider </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="col-md-6">
            <label class="string optional control-label" for="time_slider_step">Intervalo</label>
            <select class="form-control form-control-sm" id="time_slider_step" onchange="change_step_time_slider()" style="cursor:pointer;">
              <option value="day" label="Día"></option>
              <option value="week" label="Semana"></option>
              <option value="month" label="Mes"></option>
              <option value="year" label="Año"></option>
            </select>
          </div>
        </div>
        <div class="form-row mt-3">
          <div class="col-md-6">
            <label class="string optional control-label" for="time_slider_from">Desde</label>
            <input class="string optional form-control form-control-sm" type="text" id="time_slider_from" style="cursor:pointer">
          </div>
          <div class="col-md-6">
            <label class="string optional control-label" for="time_slider_to">Hasta</label>
            <input class="string optional form-control form-control-sm" type="text" id="time_slider_to" style="cursor: pointer;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <input type="button"  value="Guardar" onclick="set_time_slider()" class="btn btn-primary">
      </div>
    </div>
  </div>
</div>

<%= form_for :q, :html => {:class => 'd-flex justify-content-end', :method => :get} do |f| %>

  <div id="map">
  </div>

  <div style="position: absolute;width: 30%; left: 70%" id="sidebar_all" class="charts-container">
  <div class="sidebar pt-1 px-1" id="timeslider-container">
    <div class="card text-light chart-bg-transparent pb-0 pt-0" >
      <div class="card-header chart-header-bg-transparent py-1 px-2">
        <div class="view-data-container" >
        <i class="fas fa-window-maximize view-data" id="view-timeslider" onclick="show_sidebar('timeslider-container')"></i>
        <i class="fas fa-square view-data" onclick="expand_sidebar('timeslider-container')" ></i>
        <i class="fas fa-times view-data" onclick="hidde_sidebar('timeslider-container')"></i>
      </div>
        Rango Temporal
      </div>
      <div style="overflow-x: hidden;">
        <div class="card-body" id="filter-time-body">
          <input type="text" class="d-none" id="time-slider-from-value">
          <input type="text" class="d-none" id="time-slider-to-value">
        </div>
      </div>
    </div>
  </div>
  <div class="sidebar pt-1 px-1" id="filter-container">
    <div class="card text-light chart-bg-transparent pb-0 pt-0">
      <div class="card-header chart-header-bg-transparent py-1 px-2">
        <div class="view-data-container status-view-middle" id="status-view-sidebar" >
        <i class="fas fa-window-maximize view-data" id="view-filters" onclick="show_sidebar('filter-container')"></i>
        <i class="fas fa-square view-data" onclick="expand_sidebar('filter-container')"></i>
        <i class="fas fa-times view-data" onclick="hidde_sidebar('filter-container')"></i>
      </div>
        Filtros Activos
      </div>
      <div  style="overflow-x: hidden;">
        <div class="card-body py-1 px-2" id="filter-body">
          <input type="text" class="d-none" id="time-slider-from-value">
          <input type="text" class="d-none" id="time-slider-to-value">
        </div>
      </div>
    </div>
  </div>
    <% if can? :graphics, :visualizer %>
    <div class="sidebar pt-1 px-1" id="charts-container">
    <div class="card text-light chart-bg-transparent pb-0 pt-0">
        <div class="card-header chart-header-bg-transparent py-1 px-2">
          <div class="view-data-container status-view-middle" id="status-view-sidebar" >
            <i class="fas fa-window-maximize view-data" id="view-charts" onclick="show_sidebar('charts-container')"></i>
            <i class="fas fa-square view-data" onclick="expand_sidebar('charts-container')"></i>
            <i class="fas fa-times view-data" onclick="hidde_sidebar('charts-container')"></i>
          </div>
          Indicadores Gráficos
        </div>
        <div class="graphics d-flex align-content-start flex-wrap">
        </div>
      </div>
    <% end %>
  </div>
  </div>


   <% if can? :data, :visualizer %>
    <div class="pt-1 px-1 table_data_container position-absolute" style="top: 97vh; left: 0%; width: 70%; z-index: 401; transition: 1s; transition-delay: 0.3s">
      <div class="card text-light chart-bg-transparent mb-2" id="collapse_data" style="overflow-y: hidden; max-height: 0vh; transition:0.8s; border: none;">
        <%= render :partial => 'project_data' %>
      </div>
    </div>
  <% end %>
<% end %>

<%= render :partial =>'project_data_report' %>

<%= render :partial =>'project_data_info' %>
